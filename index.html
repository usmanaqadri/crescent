<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Mosque Prayer Board</title>
    <style>
        :root {
            /* Light mode colors */
            --bg-color: #f5f5f5;
            --card-bg: #ffffff;
            --text-color: #111;
            --subtext-color: #333;
            --accent-bg: rgba(0, 0, 0, 0.05);
            --highlight-outline: rgba(0, 0, 0, 0.08);
            --border-color: rgba(0, 0, 0, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --shuruq-bg: linear-gradient(180deg, #fff4d2, #ffe5a0);
            --shuruq-border: #f2b600;
            --shuruq-text: #5a4200;
        }

        body.dark {
            /* Dark mode overrides */
            --bg-color: #0b1220;
            --card-bg: linear-gradient(180deg, #07101a, #0e1b2a);
            --text-color: #fff;
            --subtext-color: #bbb;
            --accent-bg: rgba(255, 255, 255, 0.04);
            --highlight-outline: rgba(255, 255, 255, 0.06);
            --border-color: rgba(255, 255, 255, 0.08);
            --shadow-color: rgba(0, 0, 0, 0.6);
            --shuruq-bg: linear-gradient(180deg, #5c4200, #a27c00);
            --shuruq-border: #ffd257;
            --shuruq-text: #fff2c2;
        }

        html,
        body {
            margin: 0;
            font-family: Inter, system-ui, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.8s ease, color 0.8s ease;
        }

        .wrap {
            display: flex;
            flex-direction: column;
        }

        html,
        body,
        .wrap {
            min-height: 100vh;
            /* Fill at least the full screen */
            height: auto;
            /* But expand beyond if needed */
            background: var(--bg-color);
        }


        header {
            padding: 16px;
            text-align: center;
        }

        h1 {
            margin: 0;
            font-size: 2.2rem;
            letter-spacing: 0.6px;
        }

        .sub {
            color: var(--subtext-color);
            margin-top: 6px;
            font-size: 0.95rem;
        }

        /* --- Fade & Background Phases --- */
        #nextMessage {
            text-align: center;
            font-size: 1.4rem;
            font-weight: 500;
            margin-bottom: 14px;
            line-height: 1.6;
            opacity: 1;
            transition: opacity 0.6s ease-in-out, background-color 0.8s ease, color 0.8s ease;
            border-radius: 10px;
            padding: 10px 14px;
            display: inline-block;
            margin-left: auto;
            margin-right: auto;
        }

        #nextMessage.fade-out {
            opacity: 0;
        }

        /* Phase background styles */
        .phase-before {
            background-color: rgba(255, 215, 0, 0.15);
            /* gold/amber */
        }

        .phase-iqama {
            background-color: rgba(0, 200, 83, 0.15);
            /* soft green */
        }

        .phase-next {
            background-color: rgba(33, 150, 243, 0.15);
            /* soft blue */
        }

        .phase-shuruq {
            background-color: rgba(255, 160, 0, 0.15);
            /* warm orange */
        }

        .phase-jumuah {
            background-color: rgba(0, 150, 136, 0.15);
            /* teal */
        }

        main {
            flex: 1;
            display: flex;
            gap: 12px;
            padding: 12px;
            align-items: center;
            justify-content: center;
        }

        .card {
            display: flex;
            flex-direction: column;
            width: min(1100px, 98%);
            background: var(--card-bg);
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 8px 30px var(--shadow-color);
            transition: background 0.8s ease, box-shadow 0.8s ease;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 14px;
        }

        .prayer {
            padding: 18px;
            text-align: center;
            border-radius: 10px;
            background: var(--accent-bg);
            transition: background 0.8s ease;
        }

        .prayer.current {
            outline: 3px solid #f7d65c;
            box-shadow: 0 0 12px 2px rgba(247, 214, 92, 0.6);
            background: var(--accent-bg);
            transition: all 0.5s ease;
        }

        .name {
            font-size: 1.05rem;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .time {
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: 0.6px;
        }

        .iqama {
            margin-top: 6px;
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .countdown {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .cd-left {
            font-size: 1.1rem;
        }

        .cd-time {
            font-size: 1.6rem;
            font-weight: 700;
        }

        footer {
            text-align: center;
            padding: 10px;
            opacity: 0.8;
            font-size: 0.9rem;
            color: var(--subtext-color);
        }

        @media (max-width: 900px) {
            .grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .time {
                font-size: 1.5rem;
            }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <header style="display:flex;align-items:center;justify-content:space-between;padding:16px 24px;">
            <div style="display:flex;align-items:center;gap:12px;">
                <img src="./logo.png" alt="Mosque Logo" id="mosqueLogo"
                    style="height:60px;width:auto;border-radius:8px;">
                <div>
                    <h1 id="mosqueName" style="margin:0;">Your Mosque Name</h1>
                    <div class="sub" style="margin-top:4px;font-size:0.95rem;opacity:0.8;" id="dateLine">Loadingâ€¦</div>
                </div>
            </div>
            <div style="font-size:1.8rem;font-weight:600;" id="liveClock">--:--:--</div>
            <!-- <button id="themeToggle" style="background:none;border:1px solid var(--subtext-color);color:var(--text-color);
  padding:6px 12px;border-radius:6px;cursor:pointer;font-size:0.9rem;">
                Toggle Theme
            </button> -->
        </header>

        <main>
            <div class="card">
                <div id="nextMessage" style="
  text-align:center;
  font-size:1.4rem;
  font-weight:600;
  margin-bottom:14px;
  margin-top:6px;
"></div>

                <div class="grid" id="prayerGrid"></div>


                <!-- ðŸ•Œ Announcements Section -->
                <div id="announcements" style="margin:10px 0; padding:12px; text-align:center; border-radius:8px;
    background:rgba(255,255,255,0.04); font-size:1.05rem; line-height:1.5;">
                    <div>ðŸ“¢ Jummah Times:</div>
                    <div>11:30 AM (Hanafi)</div>
                    <div>12:30 PM (Hanafi)</div>
                    <div>1:30 PM (Jaffari)</div>
                    <br>
                    <div>ðŸ“¢ Thursday Maghrib prayer will be downstairs in the event hall</div>
                </div>
            </div>
        </main>


        <footer>
            Auto-updating prayer board â€” configured for this masjid.
        </footer>
    </div>

    <script>
        const LAT = 38.912681; // Sterling, VA latitude
        const LON = -77.464279; // Sterling, VA longitude
        const MOSQUE_NAME = "Crescent Islamic Center";
        document.getElementById('mosqueName').textContent = MOSQUE_NAME;

        const calcMethod = 2;
        let timingsToday = {};
        let iqamaTimes = {};
        let prayerOrder = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];

        // === Time Override for Testing ===
        // Change this to simulate different times.
        // Example: simulate 5:55 AM to test Fajr, or Friday 12:20 PM to test Jumuah.

        let TEST_TIME = "2025-10-12T06:03:00";
        // Example format: "2025-10-10T05:55:00"  (set to null for real-time)

        function getNow() {
            return TEST_TIME ? new Date(TEST_TIME) : new Date();
        }

        async function fetchTimings() {
            try {
                const today = getNow();
                const timestamp = Math.floor(today.getTime() / 1000);
                const url = `https://api.aladhan.com/v1/timings/${timestamp}?latitude=${LAT}&longitude=${LON}&method=${calcMethod}`;
                const res = await fetch(url);
                const json = await res.json();
                if (json && json.data && json.data.timings) {
                    timingsToday = json.data.timings;
                    document.getElementById('dateLine').textContent = getNow().toLocaleString();
                    computeIqamaTimes();
                    renderGrid();
                    autoThemeBasedOnSun();
                } else {
                    console.error('Bad timings response', json);
                }
            } catch (err) {
                console.error('Error fetching timings', err);
                document.getElementById('dateLine').textContent = 'Error fetching timings (offline?)';
            }
        }

        function parseTimeToDate(timeStr) {
            const t = timeStr.split(' ')[0];
            const [hh, mm] = t.split(':').map(Number);
            const d = getNow();
            d.setHours(hh, mm, 0, 0);
            return d;
        }

        // Convert date object to 12-hour format (e.g. 6:30 AM)
        function formatTime12(d) {
            return d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
        }

        const iqamaChanges = {
            "2025-10-01": { Fajr: "06:15", Dhuhr: "13:30", Asr: "16:45", Isha: "20:30" },
            "2025-10-05": { Fajr: "06:30", Dhuhr: "13:30", Asr: "16:45", Isha: "20:15" },
            "2025-10-12": { Fajr: "06:30", Dhuhr: "13:30", Asr: "16:30", Isha: "20:00" },
            "2025-10-26": { Fajr: "06:30", Dhuhr: "13:30", Asr: "16:15", Isha: "20:00" },
        };

        // Compute iqama times (static)
        function computeIqamaTimes() {
            const now = getNow();
            const todayKey = now.toISOString().split("T")[0];

            // Find the most recent date â‰¤ today in the schedule
            const applicableDate = Object.keys(iqamaChanges)
                .filter(d => d <= todayKey)
                .sort()
                .pop(); // last (most recent)

            const entry = iqamaChanges[applicableDate];
            if (!entry) {
                console.warn("No iqama schedule found for today or earlier!", todayKey);
                return;
            }

            // Build the Date objects for today
            const fajrIqama = parseHMToDate(entry.Fajr);
            const dhuhrIqama = parseHMToDate(entry.Dhuhr);
            const asrIqama = parseHMToDate(entry.Asr);
            const ishaIqama = parseHMToDate(entry.Isha);

            // Maghrib = adhan + 7 minutes
            const maghribAdhan = parseTimeToDate(timingsToday["Maghrib"]);
            const maghribIqama = new Date(maghribAdhan.getTime() + 7 * 60000);

            iqamaTimes = {
                Fajr: fajrIqama,
                Dhuhr: dhuhrIqama,
                Asr: asrIqama,
                Maghrib: maghribIqama,
                Isha: ishaIqama
            };
        }

        // helper
        function parseHMToDate(hm) {
            const [h, m] = hm.split(":").map(Number);
            const d = getNow();
            d.setHours(h, m, 0, 0);
            return d;
        }

        function setSpecificTime(hours24, minutes) {
            const d = getNow();
            d.setHours(hours24, minutes, 0, 0);
            return d;
        }

        function renderGrid() {
            const grid = document.getElementById("prayerGrid");
            grid.innerHTML = "";

            const now = getNow();
            const day = now.getDay(); // 0=Sun ... 5=Fri

            // Build the prayer list including Shuruq
            let prayers = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];

            // On Fridays, inject Jumuah slots instead of Dhuhr
            if (day === 5) {
                prayers = ['Fajr', 'Sunrise', 'Jumuah 1', 'Jumuah 2', 'Jumuah 3', 'Asr', 'Maghrib', 'Isha'];
            }

            const nowMs = now.getTime();
            const events = [];

            // Build event list with actual Date objects
            for (const p of prayers) {
                if (p.startsWith("Jumuah")) {
                    // Three fixed Friday slots
                    const index = parseInt(p.split(" ")[1]);
                    const times = [
                        { hour: 11, minute: 30, madhhab: "Hanafi" },
                        { hour: 12, minute: 30, madhhab: "Hanafi" },
                        { hour: 13, minute: 30, madhhab: "Jaffari" },
                    ];
                    const info = times[index - 1];
                    const d = getNow();
                    d.setHours(info.hour, info.minute, 0, 0);
                    events.push({ name: p, adhan: d, madhhab: info.madhhab });
                } else if (p === "Sunrise") {
                    const t = parseTimeToDate(timingsToday["Sunrise"]);
                    events.push({ name: "Sunrise", adhan: t });
                } else {
                    const adhan = parseTimeToDate(timingsToday[p]);
                    const iq = iqamaTimes[p];
                    events.push({ name: p, adhan, iqama: iq });
                }
            }

            // Determine next upcoming event
            const upcoming = events
                .filter(e => {
                    // If it has iqama, use that; otherwise fall back to adhan (e.g. Shuruq, Jumuah)
                    const t = e.iqama || e.adhan;
                    return t && t.getTime() > nowMs;
                })
                .sort((a, b) => {
                    const ta = a.iqama ? a.iqama.getTime() : a.adhan.getTime();
                    const tb = b.iqama ? b.iqama.getTime() : b.adhan.getTime();
                    return ta - tb;
                })[0];


            // Create all prayer cards
            for (const e of events) {
                const adhanStr = e.adhan ? formatTime12(e.adhan) : "--:--";
                const div = document.createElement("div");

                // Base card classes
                div.className = "prayer";
                if (upcoming && e.name === upcoming.name) div.classList.add("current");

                // Build card content
                if (e.name.startsWith("Jumuah")) {
                    div.innerHTML = `
        <div class="name">${e.name}</div>
        <div class="time">${adhanStr}</div>
        <div class="iqama">${e.madhhab}</div>
      `;
                } else if (e.name === "Sunrise") {
                    div.innerHTML = `
        <div class="name">Shuruq</div>
        <div class="time">${adhanStr}</div>
      `;
                } else {
                    const iqStr = e.iqama ? formatTime12(e.iqama) : "--:--";
                    div.innerHTML = `
        <div class="name">${e.name}</div>
        <div class="time">${adhanStr}</div>
        <div class="iqama">Iqama: ${iqStr}</div>
      `;
                }

                grid.appendChild(div);
            }

            updateCountdown(upcoming, events);
        }

        function updateCountdown(upcoming, events) {
            const nextMsg = document.getElementById("nextMessage");
            const now = getNow();

            if (!upcoming || (!upcoming.iqama && !upcoming.adhan)) {
                nextMsg.innerHTML = "";
                document.getElementById("countdown").textContent = "--:--:--";
                return;
            }

            const countdownString = (target) => {
                if (!target) return "--:--:--";
                let t = target;
                if (t < now) t = new Date(t.getTime() + 24 * 3600 * 1000);
                const diff = t - now;
                const h = Math.floor(diff / 3600000);
                const m = Math.floor((diff % 3600000) / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                return `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
            };

            let message = "";
            let countdownTarget = null;
            let phaseClass = "phase-next"; // default

            if (upcoming.name === "Sunrise") {
                message = `ðŸŒ… Sunrise is at ${formatTime12(upcoming.adhan)} â€” in ${countdownString(upcoming.adhan)}`;
                countdownTarget = upcoming.adhan;
                phaseClass = "phase-shuruq";
            } else if (upcoming.name.startsWith("Jumuah")) {
                message = `ðŸ•Œ The next Jumuah (${upcoming.name}) is in ${countdownString(upcoming.adhan)}`;
                countdownTarget = upcoming.adhan;
                phaseClass = "phase-jumuah";
            } else {
                const adhan = upcoming.adhan;
                const iqama = upcoming.iqama;

                if (now < adhan) {
                    message = `ðŸ•°ï¸ ${upcoming.name} time begins in ${countdownString(adhan)}`;
                    countdownTarget = adhan;
                    phaseClass = "phase-before";
                } else if (now >= adhan && now < iqama) {
                    message = `ðŸ™ The Iqama for ${upcoming.name} will be in ${countdownString(iqama)}`;
                    countdownTarget = iqama;
                    phaseClass = "phase-iqama";
                } else {
                    const currentIdx = events.findIndex(e => e.name === upcoming.name);
                    let nextEvent = events[currentIdx + 1];
                    if (!nextEvent) {
                        nextEvent = events.find(e => e.name === "Fajr");
                        if (nextEvent) {
                            const nextFajrAdhan = new Date(nextEvent.adhan.getTime() + 24 * 3600 * 1000);
                            message = `ðŸ•°ï¸ Next prayer (Fajr) time begins in ${countdownString(nextFajrAdhan)}`;
                            countdownTarget = nextFajrAdhan;
                            phaseClass = "phase-next";
                        }
                    } else {
                        message = `ðŸ•°ï¸ Next prayer (${nextEvent.name}) time begins in ${countdownString(nextEvent.adhan)}`;
                        countdownTarget = nextEvent.adhan;
                        phaseClass = "phase-next";
                    }
                }
            }

            // === Smooth fade transition ===
            if (nextMsg.innerHTML !== message) {
                nextMsg.classList.add("fade-out");
                setTimeout(() => {
                    nextMsg.innerHTML = message;
                    nextMsg.className = ""; // remove old phases & fade
                    nextMsg.classList.add(phaseClass);
                }, 300);
                setTimeout(() => nextMsg.classList.remove("fade-out"), 400);
            }

            // === Bottom countdown bar ===
            if (countdownTarget) {
                document.getElementById("nextLabel").textContent = `Next: ${formatTime12(countdownTarget)}`;
                document.getElementById("countdown").textContent = countdownString(countdownTarget);
            } else {
                document.getElementById("nextLabel").textContent = "Next: ---";
                document.getElementById("countdown").textContent = "--:--:--";
            }
        }

        fetchTimings();
        setInterval(fetchTimings, 15 * 60 * 1000);
        setInterval(() => renderGrid(), 1000);

        function updateLiveClock() {
            const now = getNow();
            const timeString = now.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', second: '2-digit' });
            document.getElementById('liveClock').textContent = timeString;
            document.getElementById('dateLine').textContent = now.toLocaleDateString(undefined, {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
        }
        updateLiveClock();
        setInterval(updateLiveClock, 1000);
        const WEEK_MS = 7 * 24 * 60 * 60 * 1000;
        setTimeout(() => {
            console.log("Weekly auto-refresh triggered");
            location.reload(true);
        }, WEEK_MS);

        // ðŸŒ™ Auto theme switching (and manual toggle)
        function applyTheme(mode) {
            if (mode === "dark") {
                document.body.classList.add("dark");
            } else {
                document.body.classList.remove("dark");
            }
            localStorage.setItem("theme", mode);
        }

        // Manual toggle handler
        document.getElementById("themeToggle").addEventListener("click", () => {
            const current = document.body.classList.contains("dark") ? "dark" : "light";
            const newMode = current === "dark" ? "light" : "dark";
            applyTheme(newMode);
        });

        // Automatic mode based on prayer times
        function autoThemeBasedOnSun() {
            if (!timingsToday["Fajr"] || !timingsToday["Maghrib"]) return;
            const now = getNow();
            const fajr = parseTimeToDate(timingsToday["Fajr"]);
            const maghrib = parseTimeToDate(timingsToday["Maghrib"]);

            // Daytime = between Fajr and Maghrib
            if (now >= fajr && now < maghrib) {
                applyTheme("light");
            } else {
                applyTheme("dark");
            }
        }

        // Restore last saved theme initially (fallback)
        applyTheme(localStorage.getItem("theme") || "light");

        // Re-check automatically every minute
        setInterval(autoThemeBasedOnSun, 60000);
    </script>

</body>

</html>