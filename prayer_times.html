<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Mosque Prayer Board</title>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            font-family: Inter, system-ui, sans-serif;
            background: #0b1220;
            color: #fff;
        }

        .wrap {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        header {
            padding: 16px;
            text-align: center;
        }

        h1 {
            margin: 0;
            font-size: 2.2rem;
            letter-spacing: 0.6px;
        }

        .sub {
            opacity: 0.8;
            margin-top: 6px;
            font-size: 0.95rem;
        }

        main {
            flex: 1;
            display: flex;
            gap: 12px;
            padding: 12px;
            align-items: center;
            justify-content: center;
        }

        .card {
            display: flex;
            flex-direction: column;
            width: min(1100px, 98%);
            background: linear-gradient(180deg, #07101a, #0e1b2a);
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 14px;
        }

        .prayer {
            padding: 18px;
            text-align: center;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.02);
        }

        .prayer.current {
            outline: 4px solid rgba(255, 255, 255, 0.06);
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.01));
        }

        .name {
            font-size: 1.05rem;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .time {
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: 0.6px;
        }

        .iqama {
            margin-top: 6px;
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .countdown {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.03);
        }

        .cd-left {
            font-size: 1.1rem;
        }

        .cd-time {
            font-size: 1.6rem;
            font-weight: 700;
        }

        footer {
            text-align: center;
            padding: 10px;
            opacity: 0.6;
            font-size: 0.9rem;
        }

        @media (max-width:900px) {
            .grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .time {
                font-size: 1.5rem
            }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <header style="display:flex;align-items:center;justify-content:space-between;padding:16px 24px;">
            <div style="display:flex;align-items:center;gap:12px;">
                <img src="./logo.png" alt="Mosque Logo" id="mosqueLogo"
                    style="height:60px;width:auto;border-radius:8px;">
                <div>
                    <h1 id="mosqueName" style="margin:0;">Your Mosque Name</h1>
                    <div class="sub" style="margin-top:4px;font-size:0.95rem;opacity:0.8;" id="dateLine">Loadingâ€¦</div>
                </div>
            </div>
            <div style="font-size:1.8rem;font-weight:600;" id="liveClock">--:--:--</div>
        </header>

        <main>
            <div class="card">
                <div class="grid" id="prayerGrid">
                    <!-- prayer cards injected here -->
                </div>

                <!-- Countdown Section -->
                <div class="countdown">
                    <div class="cd-left" id="nextLabel">Next:</div>
                    <div class="cd-time" id="countdown">--:--:--</div>
                </div>
                <!-- ðŸ•Œ Announcements Section -->
                <div id="announcements" style="margin:10px 0; padding:12px; text-align:center; border-radius:8px;
    background:rgba(255,255,255,0.04); font-size:1.05rem; line-height:1.5;">
                    <div>ðŸ“¢ Jummah Times:</div>
                    <div>11:30 AM (Hanafi):</div>
                    <div>12:30 AM (Hanafi):</div>
                    <div>1:30 PM (Jaffari):</div>
                    <div>Please park responsibly and avoid blocking driveways.</div>
                    <br>
                    <div>ðŸ“¢ Thursday Maghrib prayer will be downstairs</div>
                </div>
            </div>
        </main>


        <footer>
            Auto-updating prayer board â€” configured for this mosque.
        </footer>
    </div>

    <script>
        const LAT = 38.912681; // Sterling, VA latitude
        const LON = -77.464279; // Sterling, VA longitude
        const MOSQUE_NAME = "Crescent Islamic Center";
        document.getElementById('mosqueName').textContent = MOSQUE_NAME;

        const calcMethod = 2;
        let timingsToday = {};
        let iqamaTimes = {};
        let prayerOrder = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];

        async function fetchTimings() {
            try {
                const today = new Date();
                const timestamp = Math.floor(today.getTime() / 1000);
                const url = `https://api.aladhan.com/v1/timings/${timestamp}?latitude=${LAT}&longitude=${LON}&method=${calcMethod}`;
                const res = await fetch(url);
                const json = await res.json();
                if (json && json.data && json.data.timings) {
                    timingsToday = json.data.timings;
                    document.getElementById('dateLine').textContent = new Date().toLocaleString();
                    computeIqamaTimes();
                    renderGrid();
                } else {
                    console.error('Bad timings response', json);
                }
            } catch (err) {
                console.error('Error fetching timings', err);
                document.getElementById('dateLine').textContent = 'Error fetching timings (offline?)';
            }
        }

        function parseTimeToDate(timeStr) {
            const t = timeStr.split(' ')[0];
            const [hh, mm] = t.split(':').map(Number);
            const d = new Date();
            d.setHours(hh, mm, 0, 0);
            return d;
        }

        // Convert date object to 12-hour format (e.g. 6:30 AM)
        function formatTime12(d) {
            return d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
        }

        // Compute iqama times (static)
        function computeIqamaTimes() {
            iqamaTimes = {};
            const fajrIqama = setSpecificTime(6, 30); // 6:30 AM
            const dhuhrIqama = setSpecificTime(13, 30); // 1:30 PM
            const asrIqama = setSpecificTime(16, 45); // 4:45 PM
            const ishaIqama = setSpecificTime(20, 15); // 8:15 PM

            // Maghrib is always 7 minutes after adhan
            const maghribAdhan = parseTimeToDate(timingsToday['Maghrib']);
            const maghribIqama = new Date(maghribAdhan.getTime() + 7 * 60000);

            iqamaTimes = {
                Fajr: fajrIqama,
                Dhuhr: dhuhrIqama,
                Asr: asrIqama,
                Maghrib: maghribIqama,
                Isha: ishaIqama
            };
        }

        function setSpecificTime(hours24, minutes) {
            const d = new Date();
            d.setHours(hours24, minutes, 0, 0);
            return d;
        }

        function renderGrid() {
            const grid = document.getElementById('prayerGrid');
            grid.innerHTML = '';
            const now = new Date();
            let currentPrayer = null;

            for (let i = 0; i < prayerOrder.length; i++) {
                const p = prayerOrder[i];
                const iq = iqamaTimes[p];
                if (!iq) continue;

                const nextIq = (() => {
                    for (let j = i + 1; j < prayerOrder.length; j++) {
                        if (iqamaTimes[prayerOrder[j]]) return iqamaTimes[prayerOrder[j]];
                    }
                    return new Date(iq.getTime() + 24 * 3600 * 1000);
                })();

                if (now >= iq && now < nextIq) {
                    currentPrayer = p;
                }
            }

            for (const p of prayerOrder) {
                const adhan = timingsToday[p] ? parseTimeToDate(timingsToday[p]) : null;
                const adhanStr = adhan ? formatTime12(adhan) : '--:--';
                const iqDate = iqamaTimes[p];
                const iqStr = iqDate ? formatTime12(iqDate) : '--:--';

                const div = document.createElement('div');
                div.className = 'prayer' + (p === currentPrayer ? ' current' : '');
                div.innerHTML = `
      <div class="name">${p}</div>
      <div class="time">${adhanStr}</div>
      <div class="iqama">Iqama: ${iqStr}</div>
    `;
                grid.appendChild(div);
            }
            updateCountdown();
        }

        function updateCountdown() {
            const now = new Date();
            const futureIqamas = Object.entries(iqamaTimes)
                .map(([p, d]) => ({ p, time: d }))
                .filter(x => x.time.getTime() > now.getTime())
                .sort((a, b) => a.time - b.time);

            let next = null;
            if (futureIqamas.length > 0) next = futureIqamas[0];
            else if (iqamaTimes['Fajr'])
                next = { p: 'Fajr', time: new Date(iqamaTimes['Fajr'].getTime() + 24 * 3600 * 1000) };

            if (!next) {
                document.getElementById('nextLabel').textContent = 'Next: ---';
                document.getElementById('countdown').textContent = '--:--:--';
                return;
            }
            document.getElementById('nextLabel').textContent = `Next: ${next.p} (${formatTime12(next.time)})`;
            const diffMs = next.time - now;
            const h = Math.floor(diffMs / 3600000);
            const m = Math.floor((diffMs % 3600000) / 60000);
            const s = Math.floor((diffMs % 60000) / 1000);
            document.getElementById('countdown').textContent =
                `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        fetchTimings();
        setInterval(fetchTimings, 15 * 60 * 1000);
        setInterval(() => renderGrid(), 1000);

        function updateLiveClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', second: '2-digit' });
            document.getElementById('liveClock').textContent = timeString;
            document.getElementById('dateLine').textContent = now.toLocaleDateString(undefined, {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
        }
        updateLiveClock();
        setInterval(updateLiveClock, 1000);
        const WEEK_MS = 7 * 24 * 60 * 60 * 1000;
        setTimeout(() => {
            console.log("Weekly auto-refresh triggered");
            location.reload(true);
        }, WEEK_MS);
    </script>

</body>

</html>